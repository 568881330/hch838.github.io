<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="refresh" content="600">
    <title>我在这儿</title>
    <script>
        // if(!location.search){
        //     location.href='https://ditu.amap.com/';
        // };
    </script>
    <script src="https://webapi.amap.com/maps?v=1.4.14&key=47d57deacf67daf4fe68b31c3dcdc253"></script>
    <style>
        html,
        body,
        #container {
            margin: 0;
            height: 100%;
        }
        .in{
        position: absolute;
        top: 0;
        right: 0;
        z-index: 200;
        text-align: right;
        }
        #shijian{
            color: #00f;
        }
    </style>      
</head>
<body>
    <div id="container"></div>
    <div class="in">
        <input type="button" value="@到达我这里要多久？" id="shijian" onclick="dingwei()">
        <div id="Mudd">未使用导航</div>
        <div id="Juli"></div>
        <div id="Time"></div>
    </div>      
    <script>
        let map = new AMap.Map("container");
        let gaode = [];
        fetch('https://tsapi.amap.com/v1/track/terminal/lastpoint' + location.search + '&key=8aeec61b8d5e8a187ef462f912760781&sid=8110&correction=n')
            .then(res => res.json())
            .then(res => one(res.data))
            // .catch(er => alert('数据错误'))
        function one(data){
            let gps =[];
            data.props && gps.push(data.props.shangyidian.split(','));
            gps.push(data.location.split(','));
            if(data.props && data.props.mudd){
                Mudd.innerHTML='目的地：' + data.props.mudd;
                Juli.innerHTML='剩余路程：' + data.props.juli;
                Time.innerHTML= data.props.time + '后到达';
            }
            // console.log(gps)
            // console.log(mudd)
            // console.log(time)
            // console.log(juli)
            AMap.convertFrom(gps, "gps", function (status, result) {
                if (result.info === "ok") {
                    gaode = result.locations;//gps转高德坐标
                    // console.log(gaode)
                    let che = new AMap.Marker({
                        map: map,
                        position: gaode[gaode.length - 1],
                        icon: "1.png",
                        offset: new AMap.Pixel(-24, -12),//车偏移
                        autoRotation: true,//移动时自动旋转
                    });
                    map.setFitView();//聚焦
                    let Text = new AMap.Text({
                        map: map,
                        position: gaode[gaode.length - 1],//添加点
                        anchor:'bottom-left',
                        offset: new AMap.Pixel(20, -20)//偏移
                    });
                    let timems = new Date().getTime();//现在时间
                    timems = parseInt((timems - data.locatetime) / 1000);//现在时间减最后上传时间
                    function text() {
                        let ttt = timems >= 60 ? parseInt(timems / 60) + '分钟' : timems + '秒'
                        Text.setText(ttt + '前位置，速度' + data.speed + ' km/h');
                        timems++;
                    }//添加文字
                    text()
                    che.moveAlong(gaode,10000)
                    if (timems < 60) {
                        let runid = setInterval(function () {
                            text();
                            if (timems > 60) {
                                clearInterval(runid)
                            };
                        }, 1000
                        )
                    }
                }
            });
        }
        function dingwei() {
            shijian.value = '请稍等...';
            // 以下定位模块
            AMap.plugin('AMap.Geolocation', function() {
                var geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,//是否使用高精度定位，默认:true
                    timeout: 15000,          //超时
                });
                geolocation.getCurrentPosition(function(status,result){
                    if(status=='complete'){
                        let my = [result.position.lng,result.position.lat];//使用人的位置
                        let now = [gaode[gaode.length - 1].lng, gaode[gaode.length - 1].lat]
                        let address = result.formattedAddress.replace('市','市\n');
                        // 以下路线规划
                        AMap.plugin('AMap.Driving', function() {
                            let driving = new AMap.Driving({
                                policy: AMap.DrivingPolicy.LEAST_TIME//最快方式
                            })
                            driving.search(now, my, function (status, result) {
                                let fen = parseInt(result.routes[0].time/60)
                                fen = fen>60?parseInt(fen/60)+'小时'+fen%60+'分钟':fen+'分钟'
                                shijian.value='@到达我这里要多久？';
                                alert('您的位置大概是：\n'+address +'\n\n到达您这里大概需要时间：\n' + fen)
                            })
                        })
                        // 以上路线规划
                    }
                });
            });
            // 以上定位模块
        }
    </script>
</body>
</html>