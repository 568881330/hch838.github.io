<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轨迹</title>
    <style>
        html,
        body,
        #container {
            margin: 0;
            height: 100%;
        }

        #shijian {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 200;
        }

        .aa {
            box-shadow: 0 0 3px 2px #A020F0;
            width: 20px;
            height: 20px;
            transform: rotate(45deg);
        }

        .qq {
            position: absolute;
            border-radius: 20px;
            transform: rotate(-45deg);
            top: -20px;
            left: -20px;
        }
    </style>
</head>

<body>
    <div id='container'>加载中...</div>
    <input type="button" value="" id="shijian">
    <script src='https://webapi.amap.com/maps?v=2.0&key=47d57deacf67daf4fe68b31c3dcdc253'></script>


    <script>
        let key = JSON.parse('{"' + location.search.substr(1).replace(/\=/g, '":"').replace(/&/g, '","') + '"}')

        let pi = 1;
        let guiji = [];

        function BaiDu(j) {

            t = JSON.stringify(j.points);
            t = t.match(/(?<=de":)\d+\.\d{1,6}/g)
            // console.log(j.length);
            for (let i = 0; i < t.length; i += 2) {
                guiji.push([1 * t[i + 1], 1 * t[i]])
            }
            if (j.end_point.loc_time === j.points[j.points.length - 1].loc_time) {
                // console.log(guiji)
                let x = guiji[0][0];
                let y = guiji[0][1];
                map = new AMap.Map("container", {
                    zoom: 17,
                    center: [x, y]
                });
                if (key.qq) {//有QQ号就显示QQ头像
                    at = false;//不旋转
                    AMap.plugin('AMap.MoveAnimation', function () {
                        marker = new AMap.Marker({
                            map: map,
                            position: [x, y],
                            content: "<div class=\"aa\"><img class=\"qq\" src=\"http://q4.qlogo.cn/g?b=qq&nk=" + key.qq + "&s=40\"></div>",
                            offset: new AMap.Pixel(-10, -24)
                        });
                    });
                } else {//没QQ就加载小车
                    at = true;//旋转
                    AMap.plugin('AMap.MoveAnimation', function () {
                        marker = new AMap.Marker({
                            map: map,
                            position: [x, y],
                            icon: "https://27315.app/y/0.png",
                            offset: new AMap.Pixel(-12, -24)
                        });
                    });
                }

                let polyline = new AMap.Polyline({
                    map: map,
                    path: guiji,
                    showDir: true,
                    strokeColor: "#00f",
                    strokeWeight: 8
                });
                map.setFitView();
                let passedPolyline = new AMap.Polyline({
                    map: map,
                    strokeColor: "#ff0",  //线颜色
                    strokeWeight: 4,      //线宽
                });


                marker.on('moving', function (e) {
                    passedPolyline.setPath(e.passedPath);
                    map.setCenter(e.passedPos);
                });

                setTimeout(function () {
                    marker.moveAlong(guiji, {
                        duration: 100,
                        autoRotation: at,
                    });
                }, 2000)


            } else {
                GetData(pi++);
            }
        }






        function GetData() {
            console.log('获取云端数据' + pi)
            let i = document.createElement('script');
            i.src = "https://yingyan.baidu.com/api/v3/track/gettrack?callback=BaiDu&ak=" + key.ak + "&service_id=" + key.sid + "&entity_name=" + key.name + "&coord_type_output=gcj02&page_index=" + pi + "&page_size=100&start_time=1670319999&end_time=1670329987";
            document.body.appendChild(i);
            document.body.removeChild(i);
        }
        GetData();



    </script>
</body>

</html>